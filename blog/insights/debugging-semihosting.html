<!doctype html><html lang="en"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><link rel="icon" href="/assets/favicon/favicon.png" type="image/png" /><link rel="apple-touch-icon" href="/assets/favicon/apple-touch-icon.png" /><link rel="stylesheet" href="/assets/css/libs.bundle.css?v=4" /><link rel="stylesheet" href="/assets/css/theme.bundle.css?v=4" /><title>Debugging with PlatformIO: Part 4. Using Semihosting on ARM Targets | PlatformIO Labs</title><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Debugging with PlatformIO: Part 4. Using Semihosting on ARM Targets" /><meta name="author" content="Valerii Koval" /><meta property="og:locale" content="en_US" /><meta name="description" content="In this article we will try to take a deeper look at the semihosting capabilities and configure a simple PlatformIO project to use the I/O facilities of a computer running the PlatformIO IDE." /><meta property="og:description" content="In this article we will try to take a deeper look at the semihosting capabilities and configure a simple PlatformIO project to use the I/O facilities of a computer running the PlatformIO IDE." /><link rel="canonical" href="https://piolabs.com/blog/insights/debugging-semihosting.html" /><meta property="og:url" content="https://piolabs.com/blog/insights/debugging-semihosting.html" /><meta property="og:site_name" content="PlatformIO Labs" /><meta property="og:image" content="https://piolabs.com/assets/posts/2022-09-19-debugging-semihosting/semihosting-schematic-overview.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-19T00:00:00+03:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://piolabs.com/assets/posts/2022-09-19-debugging-semihosting/semihosting-schematic-overview.png" /><meta property="twitter:title" content="Debugging with PlatformIO: Part 4. Using Semihosting on ARM Targets" /><meta name="twitter:site" content="@PlatformIO_Org" /><meta name="twitter:creator" content="@Valerii Koval" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Valerii Koval"},"dateModified":"2022-09-19T00:00:00+03:00","datePublished":"2022-09-19T00:00:00+03:00","description":"In this article we will try to take a deeper look at the semihosting capabilities and configure a simple PlatformIO project to use the I/O facilities of a computer running the PlatformIO IDE.","headline":"Debugging with PlatformIO: Part 4. Using Semihosting on ARM Targets","image":"https://piolabs.com/assets/posts/2022-09-19-debugging-semihosting/semihosting-schematic-overview.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://piolabs.com/blog/insights/debugging-semihosting.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://piolabs.com/assets/img/platformio-logo-icon.png"},"name":"Valerii Koval"},"url":"https://piolabs.com/blog/insights/debugging-semihosting.html"}</script><link type="application/atom+xml" rel="alternate" href="https://piolabs.com/feed.xml" title="PlatformIO Labs" /></head><body><nav class="navbar navbar-expand-lg navbar-light"><div class="container"> <a class="navbar-brand" href="/"> <img src="/assets/img/platformio-labs-logo-horizontal.png" class="navbar-brand-img" alt="PlatformIO Labs"> </a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button><div class="collapse navbar-collapse" id="navbarCollapse"> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation"> <i class="fe fe-x"></i> </button><ul class="navbar-nav ms-auto"><li class="nav-item"> <a class="nav-link" href="/">Home</a></li><li class="nav-item dropdown"> <a class="nav-link dropdown-toggle" id="navbarTechnology" data-bs-toggle="dropdown" href="#" aria-haspopup="true" aria-expanded="false"> Technology </a><div class="dropdown-menu dropdown-menu-xl p-0" aria-labelledby="navbarTechnology"><div class="row gx-0"><div class="col-12 col-lg-6"><div class="dropdown-img-start"><h3 class="text-white"> In-house IDE or Next-Gen?</h3><p class="fs-sm text-white text-center"> See comparison of the existing IDE solutions in the market</p><a href="/blog/insights/next-generation-ide-for-decades.html" class="btn btn-sm btn-white shadow-dark fonFt-size-sm"> Learn More </a></div></div><div class="col-12 col-lg-6 dropdown-body"><div class="list-group list-group-flush"> <a class="list-group-item" href="/technology/next-generation-ide-framework.html"><div class="icon icon-sm text-primary-desat"> <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <g fill="none" fill-rule="evenodd"><path d="M0 0h24v24H0z" /><path d="M17.272 8.685a1 1 0 111.456-1.37l4 4.25a1 1 0 010 1.37l-4 4.25a1 1 0 01-1.456-1.37l3.355-3.565-3.355-3.565zm-10.544 0L3.373 12.25l3.355 3.565a1 1 0 01-1.456 1.37l-4-4.25a1 1 0 010-1.37l4-4.25a1 1 0 011.456 1.37z" fill="#335EEA" /> <rect fill="#335EEA" opacity=".3" transform="rotate(15 12 12)" x="11" y="4" width="2" height="16" rx="1" /> </g> </svg></div><div class="ms-4"><h6 class="text-uppercase text-primary-desat mb-0"> Next-Gen IDE Framework</h6><p class="fs-sm text-gray-700 mb-0"> Flexible, free IDE for everyone</p></div></a> <a class="list-group-item" href="/technology/modern-ui-toolkit.html"><div class="icon icon-sm text-success"> <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <g fill="none" fill-rule="evenodd"><path d="M0 0h24v24H0z" /><path d="M5.5 4h4A1.5 1.5 0 0111 5.5v1A1.5 1.5 0 019.5 8h-4A1.5 1.5 0 014 6.5v-1A1.5 1.5 0 015.5 4zm9 12h4a1.5 1.5 0 011.5 1.5v1a1.5 1.5 0 01-1.5 1.5h-4a1.5 1.5 0 01-1.5-1.5v-1a1.5 1.5 0 011.5-1.5z" fill="#335EEA" /><path d="M5.5 10h4a1.5 1.5 0 011.5 1.5v7A1.5 1.5 0 019.5 20h-4A1.5 1.5 0 014 18.5v-7A1.5 1.5 0 015.5 10zm9-6h4A1.5 1.5 0 0120 5.5v7a1.5 1.5 0 01-1.5 1.5h-4a1.5 1.5 0 01-1.5-1.5v-7A1.5 1.5 0 0114.5 4z" fill="#335EEA" opacity=".3" /> </g> </svg></div><div class="ms-4"><h6 class="text-uppercase text-success mb-0"> Modern UI Toolkit</h6><p class="fs-sm text-gray-700 mb-0"> Build beautiful user interfaces</p></div></a> <a class="list-group-item" href="/technology/trusted-package-registry.html"><div class="icon icon-sm text-danger"> <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <g fill="none" fill-rule="evenodd"><path d="M0 0h24v24H0z" /><path d="M5.5 2h13A1.5 1.5 0 0120 3.5v3A1.5 1.5 0 0118.5 8h-13A1.5 1.5 0 014 6.5v-3A1.5 1.5 0 015.5 2zM11 4a1 1 0 000 2h2a1 1 0 000-2h-2z" fill="#335EEA" opacity=".3" /><path d="M5.5 9h13a1.5 1.5 0 011.5 1.5v3a1.5 1.5 0 01-1.5 1.5h-13A1.5 1.5 0 014 13.5v-3A1.5 1.5 0 015.5 9zm5.5 2a1 1 0 000 2h2a1 1 0 000-2h-2zm-5.5 5h13a1.5 1.5 0 011.5 1.5v3a1.5 1.5 0 01-1.5 1.5h-13A1.5 1.5 0 014 20.5v-3A1.5 1.5 0 015.5 16zm5.5 2a1 1 0 000 2h2a1 1 0 000-2h-2z" fill="#335EEA" /> </g> </svg></div><div class="ms-4"><h6 class="text-uppercase text-danger mb-0"> Trusted Package Registry</h6><p class="fs-sm text-gray-700 mb-0"> Package management solution</p></div></a> <a class="list-group-item" href="https://platformio.org/"><div class="icon icon-sm text-dark"> <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <g fill="none" fill-rule="evenodd"><path d="M0 0h24v24H0z" /><path d="M18 14a3 3 0 110-6 3 3 0 010 6zm-9-3a4 4 0 110-8 4 4 0 010 8z" fill="#335EEA" opacity=".3" /><path d="M17.601 15c3.407.038 6.188 1.76 6.397 5.4.009.147 0 .6-.542.6H19.6c0-2.25-.744-4.328-1.999-6zm-17.6 5.2C.388 15.426 4.26 13 8.983 13c4.788 0 8.722 2.293 9.015 7.2.012.195 0 .8-.751.8H.727c-.25 0-.747-.54-.726-.8z" fill="#335EEA" /> </g> </svg></div><div class="ms-4"><h6 class="text-uppercase text-dark mb-0"> PlatformIO Open Source</h6><p class="fs-sm text-gray-700 mb-0"> Collaborative platform <i class="fe fe-log-out ms-3"></i></p></div></a></div></div></div></div></li><li class="nav-item"> <a class="nav-link" href="/blog/">Blog</a></li><li class="nav-item"> <a class="nav-link" href="/company/about.html">Company</a></li><li class="nav-item ps-lg-10 pt-2"><ul class="list-unstyled list-inline list-social "><li class="list-inline-item list-social-item me-3"> <a href="https://www.linkedin.com/company/platformio/" class="text-decoration-none" target="_blank"> <img src="/assets/img/icons/social/linkedin.svg" class="list-social-icon" alt="Follow on LinkedIn" title="Follow on LinkedIn"> </a></li><li class="list-inline-item list-social-item me-3"> <a href="https://twitter.com/PlatformIO_Org" class="text-decoration-none" target="_blank"> <img src="/assets/img/icons/social/twitter.svg" class="list-social-icon" alt="Follow on Twitter" title="Follow on Twitter"> </a></li><li class="list-inline-item list-social-item me-3"> <a href="https://github.com/platformio" class="text-decoration-none" target="_blank"> <img src="/assets/img/icons/social/github.svg" class="list-social-icon" alt="Follow on Github" title="Follow on Github"> </a></li></ul></li></ul></div></div></nav><div class="bg-light border-top"><nav class="bg-gray-200"><div class="container"><div class="row"><div class="col-12"><ol class="breadcrumb breadcrumb-scroll"><li class="breadcrumb-item"> <a href="/blog/" class="text-gray-700"> Blog </a></li><li class="breadcrumb-item"> <a href="/blog/insights/" class="text-gray-700"> Insights </a></li><li class="breadcrumb-item active" aria-current="page"> Debugging with PlatformIO: Part 4. Using Semihosting on ARM Targets</li></ol></div></div></div></nav><article class="bg-white"><section class="pt-8 pt-md-11"><div class="container"><div class="row justify-content-center"><div class="col-12 col-md-10 col-lg-9 col-xl-8"><h1 class="display-4 text-center"> Debugging with PlatformIO: Part 4. Using Semihosting on ARM Targets</h1><p class="lead mb-7 text-center text-muted"> A brief introduction to the semihosting mechanism and configuration steps for PlatformIO projects</p><div class="row align-items-center py-5 border-top border-bottom"><div class="col-auto"><div class="avatar avatar-lg"> <a href="https://www.linkedin.com/in/valeros/" target="_blank"><img src="/assets/img/avatars/vkoval.jpg" alt="Valerii Koval" class="avatar-img rounded-circle"></a></div></div><div class="col ms-n5"><h6 class="text-uppercase mb-0"> <a href="https://www.linkedin.com/in/valeros/" target="_blank">Valerii Koval</a></h6><div class="fs-sm text-muted"> Head of System Integration at PlatformIO Labs</div></div><div class="col-auto"> <span class="h6 text-uppercase text-muted d-none d-md-inline me-4"> Share: </span><ul class="list-unstyled list-inline list-social "><li class="list-inline-item list-social-item me-3"> <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fpiolabs.com%2Fblog%2Finsights%2Fdebugging-semihosting.html" class="text-decoration-none" target="_blank"> <img src="/assets/img/icons/social/linkedin.svg" class="list-social-icon" alt="Follow on LinkedIn" title="Follow on LinkedIn"> </a></li><li class="list-inline-item list-social-item me-3"> <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fpiolabs.com%2Fblog%2Finsights%2Fdebugging-semihosting.html" class="text-decoration-none" target="_blank"> <img src="/assets/img/icons/social/twitter.svg" class="list-social-icon" alt="Follow on Twitter" title="Follow on Twitter"> </a></li><li class="list-inline-item list-social-item me-3"> <a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fpiolabs.com%2Fblog%2Finsights%2Fdebugging-semihosting.html" class="text-decoration-none" target="_blank"> <img src="/assets/img/icons/social/facebook.svg" class="list-social-icon" alt="Follow on Facebook" title="Follow on Facebook"> </a></li></ul></div></div></div></div></div></section><section class="pt-6 pt-md-8"><div class="container"><div class="row justify-content-center"><div class="col-12 col-md-10 col-lg-9 col-xl-8"><p>When developing embedded software, it’s essential to have not only a full-featured debug probe that significantly improves the overall debugging experience but also a convenient way of sending status messages to a debug console on a host machine. This possibility can greatly help to less invasively monitor the behavior of an embedded application without stopping the whole program flow. Just imagine how useful it might be to use the “printf” function on a target device and see the output directly in the debug console on your machine without any additional hardware except a debug probe. It comes especially handy in the early development stages when there are no final I/O facilities available.</p><p>Nowadays, one of the most commonly used techniques for such tasks is called “Semihosting”. It’s a powerful debug mechanism designed to simplify the tunneling of I/O requests from a target device to a host machine. In the <a href="/blog/insights/debugging-cli.html">previous post</a>, we reviewed the debugging capabilities of the PlatformIO ecosystem in the CLI mode. In this article, we will try to take a deeper look at the semihosting capabilities and configure a simple PlatformIO project to use the I/O facilities of a computer running the PlatformIO IDE.</p><p>Throughout this post, we will be using a low-cost ARM-based board <a href="https://docs.platformio.org/en/latest/boards/ststm32/nucleo_f401re.html" target="_blank">ST Nucleo-F401RE</a> and <a href="https://docs.platformio.org/en/latest/frameworks/stm32cube.html" target="_blank">STM32Cube</a> as the development framework.</p><h3>Table of Contents</h3><ul id="markdown-toc"><li><a href="#prerequisites" id="markdown-toc-prerequisites">Prerequisites</a></li><li><a href="#what-is-semihosting" id="markdown-toc-what-is-semihosting">What is Semihosting?</a></li><li><a href="#getting-started" id="markdown-toc-getting-started">Getting Started</a></li><li><a href="#enabling-semihosting" id="markdown-toc-enabling-semihosting">Enabling Semihosting</a></li><li><a href="#adding-support-for-floating-point-numbers" id="markdown-toc-adding-support-for-floating-point-numbers">Adding Support for Floating-point Numbers</a></li><li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li><li><a href="#stay-in-touch-with-us" id="markdown-toc-stay-in-touch-with-us">Stay in touch with us</a></li></ul><h2 id="prerequisites">Prerequisites</h2><p>This article uses the following components:</p><ul><li><a href="https://docs.platformio.org/en/latest/integration/ide/vscode.html">VSCode with installed PlatformIO IDE extension</a></li><li><a href="https://docs.platformio.org/en/latest/boards/ststm32/nucleo_f401re.html">ST Nucleo-F401RE</a></li></ul><h2 id="what-is-semihosting">What is Semihosting?</h2><p>In the Arm documentation, the term <code class="language-plaintext highlighter-rouge">semihosting</code> is defined as a mechanism for communicating I/O requests from application code to a host computer running a debugger. To put it simply, it means that we can delegate some parts of application functionality (e.g. working with a keyboard, printing on a display, file I/O, etc.) to a host machine. A typical semihosting setup can be visualized as the following:</p><figure class="figure mb-7"> <img class="figure-img img-fluid rounded lift lift-lg" src="/assets/posts/2022-09-19-debugging-semihosting/semihosting-schematic-overview.png" alt="Compilation and linking process" /><figcaption class="figure-caption text-center"> Semihosting schematic overview</figcaption></figure><p>The implementation of the semihosting mechanism depends on the target architecture. In this article, we use ST Nucleo-F401RE with a Cortex-M4 MCU on-board. In our case, the semihosting implementation utilizes a special <code class="language-plaintext highlighter-rouge">BKPT (0xAB)</code> instruction which forces the CPU to enter the debug state. In this state, the control is transferred to a debugger so it can investigate whether that breakpoint should trigger a semihosting operation. Given that semihosting supports many different operations (<code class="language-plaintext highlighter-rouge">SYS_OPEN</code>, <code class="language-plaintext highlighter-rouge">SYS_SEEK</code>, <code class="language-plaintext highlighter-rouge">SYS_WRITE</code>, etc.), the processor has to specify what operation is requested and what parameters should be passed to the host machine. It’s done via the <code class="language-plaintext highlighter-rouge">R0</code> and <code class="language-plaintext highlighter-rouge">R1</code> registers. The processor stores the semihosting operation type in <code class="language-plaintext highlighter-rouge">R0</code> and prepares other parameters in a memory block pointed by <code class="language-plaintext highlighter-rouge">R1</code>. Once the processor executes the BKPT instruction and enters its debug state, the debugger checks the values in the <code class="language-plaintext highlighter-rouge">R0</code> and <code class="language-plaintext highlighter-rouge">R1</code> registers, executes the requested semihosting operation accordingly, returns the result value in <code class="language-plaintext highlighter-rouge">R0</code>, and skips the BKPT instruction to let the target continue the execution.</p><p>It’s also worth mentioning that the semihosting technique cannot offer high-speed I/O operations. Each time a semihosting operation is executed, the processor is simply stopped while the data is being transferred. The required time depends on many aspects including the type of a debug probe, target CPU speed, and even the performance of the host machine, all of that can affect the speed of semihosting operations.</p><p>Now that we know how semihosting works behind the scenes, we need to instruct the internal system calls to utilize the mechanism described above. Fortunately, the GNU Arm Embedded toolchain offers a special semihosted version of the syscalls implemented in the library called <code class="language-plaintext highlighter-rouge">rdimon</code>, we just need to properly configure the linker command with several special flags. The following project will show all the steps required to enable semihosting support.</p><h2 id="getting-started">Getting Started</h2><p>For a quick start, let’s create s basic example that should print the “Hello, World!” string to the debug console. For the sake of brevity, I will assume you already have the <a href="https://registry.platformio.org/platforms/platformio/ststm32">ST STM32</a> platform installed in your system.</p><p>First of all, let’s create a new project using PlatformIO Home Page:</p><p><a data-bigpicture="{&quot;imgSrc&quot;: &quot;/assets/posts/2022-09-19-debugging-semihosting/semihosting-new-project-1.png&quot;}" href="#"> <img class="img-fluid screenshot mw-md-100" src="/assets/posts/2022-09-19-debugging-semihosting/semihosting-new-project-1.png" /> </a></p><p>As discussed above, we need to select “ST Nucleo-F401RE” as the board and “STM32Cube” as the framework and press the “Finish” button:</p><p><a data-bigpicture="{&quot;imgSrc&quot;: &quot;/assets/posts/2022-09-19-debugging-semihosting/semihosting-new-project-2.png&quot;}" href="#"> <img class="img-fluid screenshot mw-md-100" src="/assets/posts/2022-09-19-debugging-semihosting/semihosting-new-project-2.png" /> </a></p><p>Now, let’s add some actual code that should print the “Hello world!” string. Create a new file <code class="language-plaintext highlighter-rouge">main.c</code> in the <code class="language-plaintext highlighter-rouge">src</code> folder with the following content:</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stm32f4xx_hal.h&gt;</span><span class="cp">
</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">HAL_Init</span><span class="p">();</span>

    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Messages are buffered, so "\n" is required</span>
        <span class="c1">// to flush the internal buffer immediately</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Hello world!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">HAL_Delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">SysTick_Handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HAL_IncTick</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>If we start a new debug session after this step, then the “Hello world!” string won’t be printed in the debug console. That’s expected behavior because by default STM32Cube-based projects are linked with the <code class="language-plaintext highlighter-rouge">nosys</code> library. This library implements system calls as simple stubs which don’t provide any semihosting support. That’s why we need to slightly modify our project to link appropriate libraries.</p><h2 id="enabling-semihosting">Enabling Semihosting</h2><p>Let’s go through the steps required to enable semihosting support. First of all, we need to disable the default system calls implementation using the <a href="https://docs.platformio.org/en/latest/projectconf/section_env_build.html#build-unflags">build_unflags</a> option:</p><div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[env:nucleo_f401re]</span>
<span class="py">platform</span> <span class="p">=</span> <span class="s">ststm32</span>
<span class="py">framework</span> <span class="p">=</span> <span class="s">stm32cube</span>
<span class="py">board</span> <span class="p">=</span> <span class="s">nucleo_f401re</span>

<span class="c">; Remove stub implementations
</span><span class="py">build_unflags</span> <span class="p">=</span>
    <span class="err">-lnosys</span>
    <span class="py">--specs</span><span class="p">=</span><span class="s">nosys.specs</span>
</code></pre></div></div><p>In the next step, we need to instruct the linker to use the above-mentioned <code class="language-plaintext highlighter-rouge">rdimon</code> implementations. The easiest way is to create an extra script in the root of the project (for example <code class="language-plaintext highlighter-rouge">enable_semihosting.py</code>) and add the semihosting flags directly to the default build environment:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Import </span><span class="p">(</span><span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">)</span>

<span class="n">env</span><span class="p">.</span><span class="nc">Append</span><span class="p">(</span>
    <span class="n">LINKFLAGS</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">--specs=rdimon.specs</span><span class="sh">"</span><span class="p">],</span>
    <span class="n">LIBS</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">rdimon</span><span class="sh">"</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div></div><p>In order to run that script we need to specify it in our <code class="language-plaintext highlighter-rouge">platformio.ini</code> file using the <a href="https://docs.platformio.org/en/latest/projectconf/section_env_advanced.html#extra-scripts">extra-scripts</a> option:</p><div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[env:nucleo_f401re]</span>
<span class="py">platform</span> <span class="p">=</span> <span class="s">ststm32</span>
<span class="py">framework</span> <span class="p">=</span> <span class="s">stm32cube</span>
<span class="py">board</span> <span class="p">=</span> <span class="s">nucleo_f401re</span>

<span class="c">; Remove stub implementations
</span><span class="py">build_unflags</span> <span class="p">=</span>
    <span class="err">-lnosys</span>
    <span class="py">--specs</span><span class="p">=</span><span class="s">nosys.specs</span>

<span class="c">; Add semihosting flags
</span><span class="py">extra_scripts</span> <span class="p">=</span>
    <span class="err">enable_semihosting.py</span>
</code></pre></div></div><p>In the third step, we need to configure the debug server so it will redirect the semihosting output to the debug console. It can be done in the <code class="language-plaintext highlighter-rouge">platformio.ini</code> file using the <a href="https://docs.platformio.org/en/latest/projectconf/section_env_debug.html#debug-extra-cmds">debug_extra_cmds</a> option and two special commands:</p><ul><li><code class="language-plaintext highlighter-rouge">monitor arm semihosting enable</code> enables semihosting support</li><li><code class="language-plaintext highlighter-rouge">monitor arm semihosting_fileio</code> redirects the semihosting I/O to the debug console</li></ul><p>After all those steps, the final <code class="language-plaintext highlighter-rouge">platformio.ini</code> file should look like this:</p><div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[env:nucleo_f401re]</span>
<span class="py">platform</span> <span class="p">=</span> <span class="s">ststm32</span>
<span class="py">framework</span> <span class="p">=</span> <span class="s">stm32cube</span>
<span class="py">board</span> <span class="p">=</span> <span class="s">nucleo_f401re</span>

<span class="c">; Remove stub implementations
</span><span class="py">build_unflags</span> <span class="p">=</span>
    <span class="err">-lnosys</span>
    <span class="py">--specs</span><span class="p">=</span><span class="s">nosys.specs</span>

<span class="c">; Add semihosting flags
</span><span class="py">extra_scripts</span> <span class="p">=</span>
    <span class="err">enable_semihosting.py</span>

<span class="c">; Enable semihosting
</span><span class="py">debug_extra_cmds</span> <span class="p">=</span>
    <span class="err">monitor</span> <span class="err">arm</span> <span class="err">semihosting</span> <span class="err">enable</span>
    <span class="err">monitor</span> <span class="err">arm</span> <span class="err">semihosting_fileio</span> <span class="err">enable</span>
</code></pre></div></div><p>Finally, we need to declare and call a special function <code class="language-plaintext highlighter-rouge">initialise_monitor_handles</code> at the very beginning of the <code class="language-plaintext highlighter-rouge">main</code> function:</p><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stm32f4xx_hal.h&gt;</span><span class="cp">
</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">initialise_monitor_handles</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">initialise_monitor_handles</span><span class="p">();</span>

    <span class="n">HAL_Init</span><span class="p">();</span>

    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Hello world!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">HAL_Delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">SysTick_Handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HAL_IncTick</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>Now we can start a new debug session (<code class="language-plaintext highlighter-rouge">F5</code>) and see the output in the debug console:</p><p><a data-bigpicture="{&quot;imgSrc&quot;: &quot;/assets/posts/2022-09-19-debugging-semihosting/semihosting-initial-example.png&quot;}" href="#"> <img class="img-fluid screenshot mw-md-100" src="/assets/posts/2022-09-19-debugging-semihosting/semihosting-initial-example.png" /> </a></p><p>In order to better understand how it works, let’s take a closer look at the assembly listing of an internal system call when the “Hello World!” string is passed to the <code class="language-plaintext highlighter-rouge">printf</code> function:</p><p><a data-bigpicture="{&quot;imgSrc&quot;: &quot;/assets/posts/2022-09-19-debugging-semihosting/semihosting-assembly-listing.png&quot;}" href="#"> <img class="img-fluid screenshot mw-md-100" src="/assets/posts/2022-09-19-debugging-semihosting/semihosting-assembly-listing.png" /> </a></p><p>The listing shows that before executing the BKPT (<code class="language-plaintext highlighter-rouge">0x00ab</code>) instruction, the register <code class="language-plaintext highlighter-rouge">R0</code> is loaded (via <code class="language-plaintext highlighter-rouge">R4</code>) with the value <code class="language-plaintext highlighter-rouge">5</code> which stands for <code class="language-plaintext highlighter-rouge">SYS_WRITE</code>. The register <code class="language-plaintext highlighter-rouge">R1</code> is loaded with a memory address from <code class="language-plaintext highlighter-rouge">R5</code> which was previously populated with the value of the Stack Pointer increased by four. The value in <code class="language-plaintext highlighter-rouge">R1</code> points to a three-word data block that contains the following items:</p><ul><li>Handle to a previously opened stream or file</li><li>Memory address with the data to write</li><li>Size in bytes of the data to write</li></ul><p>In our case, the value in <code class="language-plaintext highlighter-rouge">R1</code> points to the address <code class="language-plaintext highlighter-rouge">0x20017fc7</code>, so let’s take a closer look at the real example of the data block located at that address:</p><p><a data-bigpicture="{&quot;imgSrc&quot;: &quot;/assets/posts/2022-09-19-debugging-semihosting/semihosting-memory-view.png&quot;}" href="#"> <img class="img-fluid screenshot mw-md-100" src="/assets/posts/2022-09-19-debugging-semihosting/semihosting-memory-view.png" /> </a></p><p>By default, the ARM processors use the little-endian order, so all values should be read backward. The first block contains the value <code class="language-plaintext highlighter-rouge">0x01</code> which is the default value for the <code class="language-plaintext highlighter-rouge">STDOUT</code> stream, the second block contains a pointer to the address <code class="language-plaintext highlighter-rouge">0x20000310</code> and if we read the memory at that address we will see our <code class="language-plaintext highlighter-rouge">Hello World!</code> string. The final block contains the value <code class="language-plaintext highlighter-rouge">0x0D</code> which is equal to 13 bytes of the data.</p><h2 id="adding-support-for-floating-point-numbers">Adding Support for Floating-point Numbers</h2><p>By default, the STM32Cube framework is linked against a special variant of standard libraries called <code class="language-plaintext highlighter-rouge">newlib-nano</code>. It’s an optimized version of the <code class="language-plaintext highlighter-rouge">newlib</code> libraries with simplified logic and without unnecessary features. Additionally, rarely used functionality is declared using the weak symbol technique which greatly helps reduce the memory footprint. The formatted I/O operations with floating-point support are one of those features that are implemented as weak symbols. Fortunately, the process of enabling comes down to adding two flags to the linker command.</p><p>The support for floating-point I/O operations can be enabled in the same <code class="language-plaintext highlighter-rouge">enable_semihosting.py</code> file from the “Getting Started” section. Simply add two new flags <code class="language-plaintext highlighter-rouge">-Wl,-u,_printf_float</code> and <code class="language-plaintext highlighter-rouge">-Wl,-u,_printf_scanf</code> which will force the linker to pull those symbols to the final binary:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Import </span><span class="p">(</span><span class="sh">"</span><span class="s">env</span><span class="sh">"</span><span class="p">)</span>

<span class="n">env</span><span class="p">.</span><span class="nc">Append</span><span class="p">(</span>
    <span class="n">LINKFLAGS</span><span class="o">=</span><span class="p">[</span>
        <span class="sh">"</span><span class="s">--specs=rdimon.specs</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">-Wl,-u,_printf_float</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">-Wl,-u,_scanf_float</span><span class="sh">"</span>
    <span class="p">],</span>
    <span class="n">LIBS</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">rdimon</span><span class="sh">"</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div></div><h2 id="conclusion">Conclusion</h2><p>Semihosting is an extremely useful feature for testing and debugging purposes. Having it in your toolbox can greatly help you out when there are no other communication channels available. But developers should be aware of the several limitations that semihosting may bring:</p><ul><li>Due to implementation trade-offs semihosting may significantly impact the performance of an application that can result in unexpected side effects in hard real-time system applications</li><li>Semihosting only works during a debug session which means that applications compiled for semihosted development environment won’t run correctly when the target is detached from a debugger</li><li>Memory-constrained devices may not have enough resources to handle semihosting calls (especially when <code class="language-plaintext highlighter-rouge">printf</code> with floats is used)</li></ul><p>It’s also worth mentioning that there are alternatives like retargeting the <code class="language-plaintext highlighter-rouge">printf</code> output via ITM channels or even solutions from commercial companies like <strong>Segger Real-Time Transfer</strong>.</p><p>This is the final post in the “Debugging with PlatformIO” series. If you are new to the series, you may find <a href="/blog/insights/debugging-introduction.html">Debugging with PlatformIO: Part 1. Back to the Basics</a> a useful starting point.</p><p>If you liked this series, you are sure to enjoy our posts on other topics:</p><ul><li><a href="/blog/insights/memory-analysis-part-1.html">Analyze your firmware footprint with PlatformIO</a></li><li><a href="/blog/insights/unit-testing-part-1.html">Unit Testing with PlatformIO</a></li></ul><h2 id="stay-in-touch-with-us">Stay in touch with us</h2><p>Stay tuned to this blog or follow us on <a href="https://www.linkedin.com/company/platformio" target="_blank">LinkedIn</a> and Twitter <a href="https://twitter.com/PlatformIO_Org" target="_blank">@PlatformIO_Org</a> to keep up to date with the latest news, articles and tips!</p></div></div></div></section><section class="py-6 py-md-8"><div class="container"><div class="row justify-content-center"><div class="col-12 col-md-10 col-lg-9 col-xl-8"><div class="row align-items-center py-5 border-top border-bottom"><div class="col-auto"><div class="avatar avatar-lg"> <a href="https://www.linkedin.com/in/valeros/" target="_blank"><img src="/assets/img/avatars/vkoval.jpg" alt="Valerii Koval" class="avatar-img rounded-circle"></a></div></div><div class="col ms-n5"><h6 class="text-uppercase mb-0"> <a href="https://www.linkedin.com/in/valeros/" target="_blank">Valerii Koval</a></h6><div class="fs-sm text-muted"> <time datetime="2022-09-19T00:00:00+03:00"> Published on 19th Sep 2022 </time></div></div><div class="col-auto"> <span class="h6 text-uppercase text-muted d-none d-md-inline me-4"> Share: </span><ul class="list-unstyled list-inline list-social "><li class="list-inline-item list-social-item me-3"> <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fpiolabs.com%2Fblog%2Finsights%2Fdebugging-semihosting.html" class="text-decoration-none" target="_blank"> <img src="/assets/img/icons/social/linkedin.svg" class="list-social-icon" alt="Follow on LinkedIn" title="Follow on LinkedIn"> </a></li><li class="list-inline-item list-social-item me-3"> <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fpiolabs.com%2Fblog%2Finsights%2Fdebugging-semihosting.html" class="text-decoration-none" target="_blank"> <img src="/assets/img/icons/social/twitter.svg" class="list-social-icon" alt="Follow on Twitter" title="Follow on Twitter"> </a></li><li class="list-inline-item list-social-item me-3"> <a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fpiolabs.com%2Fblog%2Finsights%2Fdebugging-semihosting.html" class="text-decoration-none" target="_blank"> <img src="/assets/img/icons/social/facebook.svg" class="list-social-icon" alt="Follow on Facebook" title="Follow on Facebook"> </a></li></ul></div></div></div></div></div></section></article><section class="pt-4 pt-md-6 pb-8 pb-md-10 bg-white"><div class="container"><div class="row justify-content-center"><div class="col-12 col-md-10 col-lg-9 col-xl-8"><div class="row align-items-center"><div class="col-12 col-md"><h3 class="mb-1"> Have questions?</h3><p class="fs-lg text-muted mb-6 mb-md-0"> Join the discussion on our forum</p></div><div class="col-12 col-md-auto"> <a href="https://community.platformio.org/t/debugging-with-platformio-part-4-using-semihosting-on-arm-targets/29674" class="btn btn-primary-soft me-1 lift" target="_blank"> Continue discussion <i class="fe fe-arrow-right ms-3"></i> </a></div></div></div></div></div></section><section class="pt-7 pb-9 pt-md-10 bg-light border-top"><div class="container"><div class="row align-items-center mb-5"><div class="col-12 col-md"><h3 class="mb-0"> Popular posts</h3></div><div class="col-12 col-md-auto"> <a href="/blog/latest.html" class="btn btn-sm btn-outline-gray-300 d-none d-md-inline"> View more </a></div></div><div class="row"><div class="col-12 col-md-6 col-lg-4 d-flex"><div class="card mb-6 shadow-light-lg lift lift-lg"> <a class="card-img-top" href="/blog/insights/debugging-introduction.html"> <img src="/assets/posts/2021-09-20-debugging-introduction/title.jpg" alt="Debugging with PlatformIO: Part 1. Back to the Basics" class="card-img-top"><div class="position-relative"><div class="shape shape-bottom shape-fluid-x text-white"> <svg viewBox="0 0 2880 480" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2160 0C1440 240 720 240 720 240H0v240h2880V0h-720z" fill="currentColor" /> </svg></div></div></a> <a class="card-body" href="/blog/insights/debugging-introduction.html"><h3> Debugging with PlatformIO: Part 1. Back to the Basics</h3><p class="mb-0 text-muted"> Debugging is an inseparable part of the development process. The first part provides a brief introduction to the debugging concept and covers the basics of debugging process used in the PlatformIO IDE for VSCode.</p></a> <a class="card-meta mt-auto" href="/blog/insights/debugging-introduction.html"><hr class="card-meta-divider"><div class="avatar avatar-sm me-2"> <img src="/assets/img/avatars/vkoval.jpg" alt="Valerii Koval" class="avatar-img rounded-circle"></div><h6 class="text-uppercase text-muted me-2 mb-0"> Valerii Koval</h6><p class="h6 text-uppercase text-muted mb-0 ms-auto"> <time datetime="2021-09-20T00:00:00+03:00">Sep 20</time></p></a></div></div><div class="col-12 col-md-6 col-lg-4 d-flex"><div class="card mb-6 shadow-light-lg lift lift-lg"> <a class="card-img-top" href="/blog/news/platformio-oss-april-2022-updates.html"> <img src="/assets/posts/oss-updates/platformio-oss-april-news.jpg" alt="PlatformIO Open Source April Updates" class="card-img-top"><div class="position-relative"><div class="shape shape-bottom shape-fluid-x text-white"> <svg viewBox="0 0 2880 480" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2160 0C1440 240 720 240 720 240H0v240h2880V0h-720z" fill="currentColor" /> </svg></div></div></a> <a class="card-body" href="/blog/news/platformio-oss-april-2022-updates.html"><h3> PlatformIO Open Source April Updates</h3><p class="mb-0 text-muted"> PlatformIO Core 5.2.5, New boards & dev-kits, Support for the latest Arduino ESP32 core v2.0, Updated Arduino Cores for ST STM32, Nordic nRF52 and Mbed-enabled devices</p></a> <a class="card-meta mt-auto" href="/blog/news/platformio-oss-april-2022-updates.html"><hr class="card-meta-divider"><div class="avatar avatar-sm me-2"> <img src="/assets/img/avatars/vkoval.jpg" alt="Valerii Koval" class="avatar-img rounded-circle"></div><h6 class="text-uppercase text-muted me-2 mb-0"> Valerii Koval</h6><p class="h6 text-uppercase text-muted mb-0 ms-auto"> <time datetime="2022-05-02T00:00:00+03:00">May 02</time></p></a></div></div><div class="col-12 col-md-6 col-lg-4 d-flex"><div class="card mb-6 shadow-light-lg lift lift-lg"> <a class="card-img-top" href="/blog/news/platformio-core-5-0-released.html"> <img src="/assets/posts/2020-09-03-platformio-core-5-0-released/platformio-core-5-0-released.png" alt="PlatformIO Core 5.0 🚀" class="card-img-top"><div class="position-relative"><div class="shape shape-bottom shape-fluid-x text-white"> <svg viewBox="0 0 2880 480" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2160 0C1440 240 720 240 720 240H0v240h2880V0h-720z" fill="currentColor" /> </svg></div></div></a> <a class="card-body" href="/blog/news/platformio-core-5-0-released.html"><h3> PlatformIO Core 5.0 🚀</h3><p class="mb-0 text-muted"> PlatformIO Core 5.0 is out with full support for the PlatformIO Trusted Registry, SCons 4.0, and custom targets</p></a> <a class="card-meta mt-auto" href="/blog/news/platformio-core-5-0-released.html"><hr class="card-meta-divider"><div class="avatar avatar-sm me-2"> <img src="/assets/img/avatars/ikravets.jpg" alt="Ivan Kravets" class="avatar-img rounded-circle"></div><h6 class="text-uppercase text-muted me-2 mb-0"> Ivan Kravets</h6><p class="h6 text-uppercase text-muted mb-0 ms-auto"> <time datetime="2020-09-03T00:00:00+03:00">Sep 03</time></p></a></div></div></div></div></section></div><div class="position-relative"><div class="shape shape-bottom shape-fluid-x text-dark"> <svg viewBox="0 0 2880 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 48h2880V0h-720C1442.5 52 720 0 720 0H0v48z" fill="currentColor"/></svg></div></div><section class="bg-dark "><footer class="py-8 py-md-11 bg-dark border-gray-800-50 "><div class="container"><div class="row"><div class="col-12 col-md-6 col-lg-4"> <a href="/"><img src="/assets/img/platformio-labs-logo-horizontal-white.png" alt="PlatformIO Labs" class="img-fluid mb-2 mw-lg-75"></a><p class="text-gray-400 mb-2"> Make embedded developers and teams happy.</p><ul class="list-unstyled list-inline list-social mb-2"><li class="list-inline-item list-social-item me-3"> <a href="https://www.linkedin.com/company/platformio/" class="text-decoration-none" target="_blank"> <img src="/assets/img/icons/social/linkedin.svg" class="list-social-icon" alt="Follow on LinkedIn" title="Follow on LinkedIn"> </a></li><li class="list-inline-item list-social-item me-3"> <a href="https://twitter.com/PlatformIO_Org" class="text-decoration-none" target="_blank"> <img src="/assets/img/icons/social/twitter.svg" class="list-social-icon" alt="Follow on Twitter" title="Follow on Twitter"> </a></li><li class="list-inline-item list-social-item me-3"> <a href="https://www.facebook.com/platformio" class="text-decoration-none" target="_blank"> <img src="/assets/img/icons/social/facebook.svg" class="list-social-icon" alt="Follow on Facebook" title="Follow on Facebook"> </a></li><li class="list-inline-item list-social-item me-3"> <a href="https://github.com/platformio" class="text-decoration-none" target="_blank"> <img src="/assets/img/icons/social/github.svg" class="list-social-icon" alt="Follow on Github" title="Follow on Github"> </a></li></ul><p class="mb-6 mb-md-2 text-gray-600"> <small>© 2014-2023 PlatformIO Labs.</small></p></div><div class="col-12 col-md-6 col-lg-2"><h6 class="text-uppercase text-gray-400"> Company</h6><ul class="list-unstyled text-muted mb-6 mb-md-8 mb-lg-0"><li class="mb-3"> <a href="/" class="text-reset"> Home </a></li><li class="mb-3"> <a href="/company/about.html" class="text-reset"> About Us </a></li><li class="mb-3"> <a href="/blog/" class="text-reset"> Blog </a></li><li class="mb-3"> <a href="/#contact-us" class="text-reset"> Contact Us </a></li></ul></div><div class="col-12 col-md-6 col-lg-3"><h6 class="text-uppercase text-gray-400"> Technology</h6><ul class="list-unstyled text-muted mb-6 mb-md-8 mb-lg-0"><li class="mb-3"> <a href="/technology/next-generation-ide-framework.html" class="text-reset"> Next-Gen IDE Framework </a></li><li class="mb-3"> <a href="/technology/modern-ui-toolkit.html" class="text-reset"> Modern UI Toolkit </a></li><li class="mb-3"> <a href="/technology/trusted-package-registry.html" class="text-reset"> Trusted Package Registry </a></li><li> <a href="https://platformio.org/" class="text-reset"> PlatformIO Open Source </a></li></ul></div><div class="col-12 col-md-6 col-lg-3"><h6 class="text-uppercase text-gray-400"> Legal</h6><ul class="list-unstyled text-muted mb-0"><li class="mb-3"> <a href="/legal/code-of-conduct.html" class="text-reset"> Code of Conduct </a></li><li class="mb-3"> <a href="/legal/privacy.html" class="text-reset"> Privacy Policy </a></li><li class="mb-3"> <a href="/legal/terms-of-use.html" class="text-reset"> Terms of Use </a></li><li class="mb-3"> <a href="/legal/trademarks.html" class="text-reset"> Trademarks </a></li></ul></div></div></div></footer></section><script src="/assets/js/vendor.bundle.js?v=4"></script> <script src="/assets/js/theme.bundle.js?v=4"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-CNM31GXX7Y"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-CNM31GXX7Y'); </script></body></html>
